/* Author:

*/

$(function() {

  /**************************
   * Models
   **************************/

  var <%= metadata.className %> = Backbone.Model.extend({
    
    defaults: function() {
      return {
        <% for (field in metadata.fields) { %>
        <%= field %>: '',
        <% } %>
      }
    },
    
    idAttribute: '_id',

    initialize: function() {
      // nothing for now
    }
  });

  var <%= metadata.name%>List = Backbone.Collection.extend({
    
    model: <%= metadata.className %>,
    
    url: '/lists.json/<%= metadata.name %>',
    
  });
  
  var <%= metadata.name %> = new <%= metadata.name %>List;
  
  var <%= metadata.className %>View = Backbone.View.extend({
    
    tagName: 'tr',
    
    template: $('#listItemTemplate').text(),
    
    events: {
      
    },
    
    initialize: function() {
      this.model.bind('change', this.render, this);
      this.model.bind('destroy', this.remove, this);
    },
    
    render: function() {
      this.$el.html(Mustache.render(this.template, this.model.toJSON()));
      return this;
    },
    
  });
  
  var NewItemView = Backbone.View.extend({
    el: $('#newItemModal'),

    events: {
      'click #addItemCancel'  : 'cancel',
      'click #addItemSubmit'  : 'submit',
      'shown'                 : 'shown',
    },
    
    initialize: function() {
      this._modelBinder = new Backbone.ModelBinder();
      
      this.render();
    },
    
    render: function() {
      this._modelBinder.bind(this.model, this.el);
    },
    
    close: function() {
      this._modelBinder.unbind();
    },
    
    show: function() {
      this.$el.modal('show');
    },
    
    shown: function() {
      this.$('input').first().focus();
    },
    
    cancel: function(e) {
      this.$el.modal('hide');
    },
    
    submit: function(e) {
      <%= metadata.name %>.create(this.model.toJSON());
    },
  });  

  var AppView = Backbone.View.extend({
    el: $('#listview'),
    
    events: {
      'click #refresh'        : 'refresh',
      'click #addItem'        : 'addNewItem',
      'click #delete'         : 'delete',
    },
    
    initialize: function() {

      this.table = this.$('tbody');
      
      this.newItemView = new NewItemView({
        model: new <%= metadata.className %>,
      });
      
      // bind model events
      <%= metadata.name %>.bind('add', this.addOne, this);
      <%= metadata.name %>.bind('reset', this.addAll, this);
      <%= metadata.name %>.bind('all', this.render, this);

      <%= metadata.name %>.fetch();
    },
    
    render: function() {
      return this;
    },
    
    refresh: function(e) {
      
    },
    
    addNewItem: function(e) {
      this.newItemView.show();
    },
    
    delete: function(e) {
      
    },
    
    addOne: function(item) {
      var view = new <%= metadata.className %>View({
        model: item
      });
      this.table.append(view.render().el);
    },
    
    addAll: function() {
      <%= metadata.name %>.each($.proxy(this.addOne, this));
    },
    
    
  });
  
  var App = new AppView;
  
}) 
