/* Author:

*/

$(function() {

  /**************************
   * Models
   **************************/

  var <%= metadata.className %> = Backbone.Model.extend({
    
    defaults: function() {
      return {
        <% for (field in metadata.fields) { %>
        <%= field %>: '',
        <% } %>
      }
    },
    
    idAttribute: '_id',

    initialize: function() {
      var selectable = new Backbone.Picky.Selectable(this);
      _.extend(this, selectable);
    }
  });

  var <%= metadata.name%>List = Backbone.Collection.extend({
    
    model: <%= metadata.className %>,
    
    url: '/lists.json/<%= metadata.name %>',
    
    initialize: function() {
      var multiSelect = new Backbone.Picky.MultiSelect(this);
      _.extend(this, multiSelect);
    }

  });
  
  var <%= metadata.name %> = new <%= metadata.name %>List;
  
  var <%= metadata.className %>View = Backbone.View.extend({
    
    tagName: 'tr',
    
    template: $('#listItemTemplate').text(),
    
    events: {
      'click input[type="checkbox"].selector' : 'select',
      'click .namefield'                      : 'edit',
      'click'                                 : 'select',
    },
    
    initialize: function() {
      this.model.on('change', this.render, this);
      this.model.on('destroy', this.remove, this);
      this.model.on('selected', this.selected, this);
      this.model.on('deselected', this.deselected, this);
    },
    
    render: function() {
      this.$el.html(Mustache.render(this.template, this.model.toJSON()));
      if (this.model.selected) {
        this.$('input[type="checkbox"].selector').attr('checked', true);
      }
      
      return this;
    },
    
    select: function() {
      this.model.toggleSelected();
    },
    
    edit: function(e) {
      e.preventDefault();
      e.stopPropagation();
      var editView = new EditItemView({
        model: this.model
      });
    },
    
    selected: function(e) {
      this.$('input[type="checkbox"].selector').attr('checked', true);
    },

    deselected: function(e) {
      this.$('input[type="checkbox"].selector').attr('checked', false);
    },
  });
  
  var NewItemView = Backbone.View.extend({
    el: $('#newItemModal'),

    events: {
      'click #addItemCancel'  : 'cancel',
      'click #addItemSubmit'  : 'submit',
      'submit #newItemForm'   : 'submit',
      'shown'                 : 'shown',
      'hidden'                : 'onHidden',
    },
    
    initialize: function() {
      this._modelBinder = new Backbone.ModelBinder();
            
      this.render();
    },
    
    render: function() {
      this._modelBinder.bind(this.model, this.el);
    },
    
    show: function() {
      this.$el.modal('show');
    },
    
    shown: function() {
      this.$('input').first().focus();
    },
    
    onHidden: function() {
      this.model.set(this.model.defaults());
    },
    
    cancel: function(e) {
      this.$el.modal('hide');
    },
    
    submit: function(e) {
      e.preventDefault();
      <%= metadata.name %>.create(this.model.toJSON());
      this.$el.modal('hide');
    },
  });  

  var EditItemView = Backbone.View.extend({
    el: $('#editItemModal'),
    
    events: {
      'shown'                   : 'onShown',
      'hide'                    : 'onHide',
      'click #editItemCancel'   : 'onCancel',
      'click #editItemSubmit'   : 'submit',
      'submit #editItemForm'    : 'submit',
    },
    
    initialize: function() {
      this._modelBinder = new Backbone.ModelBinder();
      
      this.render();
      this.model.on('change', this.onChanged, this);
      
      this.$el.modal('show');
      this.processCancel = true;
    },
    
    render: function() {
      this._modelBinder.bind(this.model, this.el);
    },
    
    onShown: function() {
      this.$('input').first().focus();
    },
    
    onHide: function() {
      this._modelBinder.unbind();
      this.model.off(null, this.onChanged, this);
      this.undelegateEvents();

      if (this.processCancel) this.cancel();
    },
    
    onChanged: function() {
      this.revert || (this.revert = {});
      
      for (var field in this.model.changedAttributes()) {
        if (this.revert.hasOwnProperty(field)) continue;
        
        this.revert[field] = this.model.previous(field);
      }
    },
    
    onCancel: function(e) {
      this.cancel();
      this.$el.modal('hide');
    },
    
    cancel: function() {
      if (this.revert) {
        this.model.off(null, this.onChanged, this);
        this.model.set(this.revert);
      }
      
      this.processCancel = false;
    },
    
    submit: function(e) {
      e.preventDefault();
      var self = this;
      
      this.model.save({}, {
        success: function(model, response) {
          self.processCancel = false;
          self.$el.modal('hide');
        }
      })
    }
  })

  var AppView = Backbone.View.extend({
    el: $('#listview'),
    
    events: {
      'click #refresh'        : 'refresh',
      'click #addItem'        : 'addNewItem',
      'click #delete'         : 'delete',
      'click #selectAll'      : 'toggleSelectAll',
      'click #editItem'       : 'editItem',
    },
    
    initialize: function() {

      this.table = this.$('tbody');
      
      this.newItemView = new NewItemView({
        model: new <%= metadata.className %>,
      });
      
      // bind model events
      <%= metadata.name %>.on('add', this.addOne, this);
      <%= metadata.name %>.on('reset', this.addAll, this);
      <%= metadata.name %>.on('all', this.render, this);
      <%= metadata.name %>.on('select:some', this.selectedSome, this);
      <%= metadata.name %>.on('select:all', this.selectedAll, this);
      <%= metadata.name %>.on('select:none', this.deselected, this);

      <%= metadata.name %>.fetch();
    },
    
    render: function() {
      return this;
    },
    
    refresh: function(e) {
      
    },
    
    addNewItem: function(e) {
      this.newItemView.show();
    },
    
    delete: function(e) {
      // TODO: pop up a confirmation dialog
      for(var i in <%= metadata.name %>.selected) {
        var selected = <%= metadata.name %>.selected[i];
        selected.deselect();
        selected.destroy({wait: true});
      }
    },
    
    editItem: function(e) {
      for (var i in <%= metadata.name %>.selected) {
        var editView = new EditItemView({
          model: <%= metadata.name %>.selected[i]
        });
      }
    },
    
    addOne: function(item) {
      var view = new <%= metadata.className %>View({
        model: item
      });
      this.table.append(view.render().el);
    },
    
    addAll: function() {
      <%= metadata.name %>.each($.proxy(this.addOne, this));
    },

    enableDeleteButton: function() {
      this.$('#delete')
        .removeClass('disabled')
        .removeAttr('disabled');
    },
    
    disableDeleteButton: function() {
      this.$('#delete')
        .addClass('disabled')
        .attr('disabled', 'disabled');
    },
    
    enableEditButton: function() {
      this.$('#editItem')
        .removeClass('disabled')
        .removeAttr('disabled');
    },
    
    disableEditButton: function() {
      this.$('#editItem')
        .addClass('disabled')
        .attr('disabled', 'disabled');
    },
    
    selectedSome: function(e) {
      this.enableDeleteButton();
      if (<%= metadata.name %>.selectedLength == 1) {
        this.enableEditButton();
      }
      else {
        this.disableEditButtion();
      }
    },
    
    selectedAll: function(e) {
      this.enableDeleteButton();
      if (<%= metadata.name %>.selectedLength == 1) {
        this.enableEditButton();
      }
      else {
        this.disableEditButton();
      }
    },
    
    deselected: function(e) {
      this.disableDeleteButton();
      this.disableEditButton();
    },
    
    toggleSelectAll: function(e) {
      <%= metadata.name %>.toggleSelectAll();
    }
  });
  
  var App = new AppView;
  
}) 
