/* Author:

*/

Application = Em.Application.create({
  listName: 'Passwords',
  
  ready: function() {
    Application.passwordsController.fill();
    
    $('#addItemModal').modal();
    $('#addItemModal').on('hidden', function() {
      Application.addItemModal.hide();
    });
  }
});

/**************************
 * Models
 **************************/

Application.Password = Em.Object.extend({
  name: '',
  url: '',
  username: '',
  password: '',
  securityQuestion: '',
  securityAnswer: ''
});

/**************************
 * Array Controllers
 **************************/
Application.passwordsController = Em.ArrayProxy.create({
  content: [],
  
  fill: function() {
    var me = this;
    
    $.getJSON('/lists/passwords/all.json', function(data) {
      $(data).each(function(index, value) {
        var password = me.addItem(value);
      });
    });
  },
  
  addItem: function(password) {
    var newPassword = Application.Password.create(password);
    this.pushObject(newPassword);
  },

  postNewItem: function(password) {
    var me = this;
    
    $.ajax({
      url: '/lists/passwords', 
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(password),
      success: function(result, status, xhr) {
        var path = xhr.getResponseHeader('Location');
        var id = path.split('/').pop();
        var newPassword = Application.Password.create(password);
        newPassword.set('_id', id);
        me.pushObject(newPassword);
        
        Application.addItemView.hide();
      }
    });
  },
});

/*************************
 * Views
 *************************/
Application.ListView = Em.View.extend({
  listNameBinding: 'Application.listName',
  
  refresh: function(event) {
    alert('refresh');
  },
  
  addItem: function(event) {
    $('#addItemModel input:first').focus();
    $('#addItemModal').modal('show');
  },
}); 
 
Application.ItemView = Em.View.extend({
  nameBinding: 'content.name',
  urlBinding: 'content.url',
  usernameBinding: 'content.username',
  passwordBinding: 'content.password',
});

Application.addItemView = Em.View.extend({
  newItem: Application.Password.create(),
  
  hide: function() {
    this.clearInputs();
    $('#addItemModal').modal('hide');
  },
  
  change: function(event) {
    var password = this.get('password');
    
    if ('' != password.get('name') || '' != password.get('url') || '' != password.get('username') || '' != password.get('password'))
      $('#addItemModal .submit').removeClass('disabled');
    else
      $('#addItemModal .submit').addClass('disabled');
  },
  
  cancel: function() {
    this.hide();
  },
  
  submit: function() {
    Application.passwordsController.postNewItem(this.get('password'));
  },
  
  clearInputs: function() {
    var password = this.get('password');
    password.set('name', '');
    password.set('url', '');
    password.set('username', '');
    password.set('password', '');
  }
});